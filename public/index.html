<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<title>Cyber IRC</title>

<style>
*{box-sizing:border-box}
html,body{
 margin:0;height:100%;
 background:#04060b;
 font-family:'Share Tech Mono',monospace;
 color:#00ffcc;
 overflow:hidden;
}
body::after{
 content:"";
 position:fixed;inset:0;
 pointer-events:none;
 background:repeating-linear-gradient(
  to bottom,
  rgba(0,0,0,0) 0px,
  rgba(0,0,0,0) 2px,
  rgba(0,0,0,.15) 3px
 );
 opacity:.25;
}
#loginScreen{
 position:fixed;inset:0;
 display:flex;align-items:center;justify-content:center;
 background:#04060b;z-index:100;
}
.login{
 width:90%;max-width:320px;
 border:1px solid rgba(0,255,255,.3);
 padding:22px;
}
.login h3{
 font-family:'Orbitron',sans-serif;
 color:#0ff;text-align:center;
 letter-spacing:2px;
}
.login input,.login button{
 width:100%;margin:10px 0;padding:10px;
 background:#000;border:1px solid rgba(0,255,255,.35);
 color:#00ffcc;
}
#app{display:none;height:100dvh;flex-direction:column}
.header{
 font-family:'Orbitron',sans-serif;
 text-align:center;
 padding:10px;
 border-bottom:1px solid rgba(0,255,255,.3);
}
.room{font-size:11px;color:#0aa}
.chat{flex:1;overflow-y:auto;padding:12px}
.msg{margin-bottom:8px}
.time{font-size:10px;color:#055;margin-right:6px}
.self{color:#00ffff}
.other{color:#ff6b6b}
.reply-ref{
 font-size:11px;
 color:#0aa;
 border-left:2px solid #0ff;
 padding-left:6px;
 margin-bottom:4px;
}
.tick{margin-left:6px}
.delivered{color:#ff3b3b}
.read{color:#8b5cf6}
.input-wrap{
 display:flex;align-items:center;
 border-top:1px solid rgba(0,255,255,.3);
 background:#000;padding:10px;
}
.cursor{margin-right:6px}
input{flex:1;background:#000;border:none;color:#00ffcc;font-size:16px}
</style>
</head>

<body>

<div id="loginScreen">
 <div class="login">
  <h3>ENTER IRC</h3>
  <input id="u" placeholder="username">
  <input id="r" placeholder="room">
  <button onclick="enter()">CONNECT</button>
 </div>
</div>

<div id="app">
 <div class="header">â›§ CYBER IRC â›§ <div id="roomName" class="room"></div></div>
 <div id="chat" class="chat"></div>
 <div id="replying" class="reply-ref" style="display:none"></div>
 <div class="input-wrap">
  <span class="cursor">$</span>
  <input id="i" placeholder="type message">
 </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const chat = document.getElementById("chat");
const input = document.getElementById("i");
const replying = document.getElementById("replying");

let USER = localStorage.getItem("user");
let ROOM = localStorage.getItem("room");
let replyTo = null;
let typingTimer;
let encrypted = false;

if(USER && ROOM) start();

function enter(){
 USER=u.value.trim();
 ROOM=r.value.trim();
 localStorage.setItem("user",USER);
 localStorage.setItem("room",ROOM);
 start();
}

function start(){
 loginScreen.style.display="none";
 app.style.display="flex";
 roomName.innerText="#"+ROOM;
 socket.emit("join",{user:USER,room:ROOM});
}

/* ---------- HISTORY ---------- */
socket.on("history", msgs => {
 chat.innerHTML="";
 msgs.forEach(render);

 // ðŸ”¥ FIX: reopen browser â†’ mark delivered as read
 if (document.visibilityState === "visible") {
  msgs.forEach(m=>{
   if(m.user!==USER && m.status==="delivered"){
    socket.emit("msg:read", m._id);
   }
  });
 }

 chat.scrollTop=chat.scrollHeight;
});

/* ---------- NEW MESSAGE ---------- */
socket.on("msg", m=>{
 render(m);
 if(m.user!==USER && document.visibilityState==="visible"){
  socket.emit("msg:read", m._id);
 }
});

/* ---------- READ RECEIPT ---------- */
socket.on("msg:read", data => {
  const el = document.querySelector(`[data-id="${data.id}"]`);
  if (!el) return;

  const tick = el.querySelector(".tick");
  if (!tick) return;

  tick.classList.remove("delivered");
  tick.classList.add("read");
});

/* ---------- VISIBILITY CHANGE ---------- */
window.addEventListener("focus", () => {
  document.querySelectorAll(".msg").forEach(el => {
    const id = el.dataset.id;
    const tick = el.querySelector(".tick");

    if (id && tick && tick.classList.contains("delivered")) {
      socket.emit("msg:read", id);
    }
  });
});

/* ---------- TYPING ---------- */
input.oninput=()=>{
 socket.emit("typing:start");
 clearTimeout(typingTimer);
 typingTimer=setTimeout(()=>socket.emit("typing:stop"),600);
};

socket.on("typing:start",u=>{
 replying.innerText=`${u} typingâ€¦`;
 replying.style.display="block";
});

socket.on("typing:stop",()=>{
 if(!replyTo) replying.style.display="none";
});

/* ---------- ENCRYPT ---------- */
function toggleEncrypt(on){
 document.querySelectorAll(".msg").forEach(el=>{
  const textEl=el.querySelector(".text");
  if(!textEl) return;

  if(on){
   if(!el.dataset.raw) el.dataset.raw=textEl.textContent;
   textEl.textContent=textEl.textContent
    .split("")
    .map(c=>String.fromCharCode(0x4e00+(c.charCodeAt(0)%2000)))
    .join("");
  }else if(el.dataset.raw){
   textEl.textContent=el.dataset.raw;
  }
 });
}

/* ---------- INPUT ---------- */
input.onkeydown=e=>{
 if(e.key!=="Enter") return;
 const text=input.value.trim();
 if(!text) return;

 if(text==="/clear"){
  chat.innerHTML="";
  input.value="";
  return;
 }
 if(text==="/leave"){
  localStorage.clear();
  location.reload();
  return;
 }
 if(text==="/encrypt"){
  encrypted=true; toggleEncrypt(true); input.value=""; return;
 }
 if(text==="/decrypt"){
  encrypted=false; toggleEncrypt(false); input.value=""; return;
 }

 socket.emit("msg",{text,replyTo});
 replyTo=null;
 replying.style.display="none";
 input.value="";
};

/* ---------- RENDER ---------- */
function render(m){
 const el=document.createElement("div");
 el.className="msg";
 el.dataset.id=m._id;

 el.innerHTML=`
 ${m.replyTo?`<div class="reply-ref">â†ª ${m.replyTo.user}: ${m.replyTo.text.slice(0,40)}</div>`:""}
 <span class="time">[${new Date(m.created).toLocaleTimeString([],{
  hour:"2-digit",minute:"2-digit"})}]</span>
 <span class="${m.user===USER?'self':'other'}">${m.user}@${ROOM}</span>
 :: <span class="text">${m.text}</span>
 ${m.user===USER?`<span class="tick ${m.status}">âœ”</span>`:""}
 `;

 chat.appendChild(el);

 el.onclick=()=>{
  replyTo={messageId:m._id,user:m.user,text:m.text,created:m.created};
  replying.innerText=`â†ª replying to ${m.user}`;
  replying.style.display="block";
 };

 chat.scrollTop=chat.scrollHeight;
}
</script>
</body>
</html>

