<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<title>Cyber IRC</title>

<style>
*{box-sizing:border-box}
html,body{
 margin:0;height:100%;
 background:#04060b;
 font-family:'Share Tech Mono',monospace;
 color:#00ffcc;
 overflow:hidden;
}
body::after{
 content:"";
 position:fixed;inset:0;
 pointer-events:none;
 background:repeating-linear-gradient(
  to bottom,
  rgba(0,0,0,0) 0px,
  rgba(0,0,0,0) 2px,
  rgba(0,0,0,.15) 3px
 );
 opacity:.25;
}
#loginScreen{
 position:fixed;inset:0;
 display:flex;align-items:center;justify-content:center;
 background:#04060b;z-index:100;
}
.login{
 width:90%;max-width:320px;
 border:1px solid rgba(0,255,255,.3);
 padding:22px;
}
.login h3{
 font-family:'Orbitron',sans-serif;
 color:#0ff;text-align:center;
 letter-spacing:2px;
}
.login input,.login button{
 width:100%;margin:10px 0;padding:10px;
 background:#000;border:1px solid rgba(0,255,255,.35);
 color:#00ffcc;
}
#app{display:none;height:100dvh;flex-direction:column}
.header{
 font-family:'Orbitron',sans-serif;
 text-align:center;
 padding:10px;
 border-bottom:1px solid rgba(0,255,255,.3);
 position:relative;
}
.room{font-size:11px;color:#0aa}
.status-dot{
 display:inline-block;
 width:8px;height:8px;
 border-radius:50%;
 margin-left:8px;
}
.status-online{background:#00ff00}
.status-offline{background:#ff3b3b}
.chat{flex:1;overflow-y:auto;padding:12px}
.msg{margin-bottom:8px}
.time{
 font-size:11px; /* Increased from 10px to 11px */
 color:#055;
 margin-right:6px;
}
.self{color:#00ffff}
.other{color:#ff6b6b}
.reply-ref{
 font-size:11px;
 color:#0aa;
 border-left:2px solid #0ff;
 padding-left:6px;
 margin-bottom:4px;
}
.tick{margin-left:6px}
.delivered{color:#ff3b3b}
.read{color:#8b5cf6}
.input-wrap{
 display:flex;align-items:center;
 border-top:1px solid rgba(0,255,255,.3);
 background:#000;padding:10px;
}
.cursor{margin-right:6px}
input{flex:1;background:#000;border:none;color:#00ffcc;font-size:16px}
.typing{
 position:absolute;
 bottom:-20px;
 left:50%;
 transform:translateX(-50%);
 font-size:11px;
 color:#0aa;
}
</style>
</head>

<body>

<audio id="messageSound" preload="auto">
  <source src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" type="audio/mpeg">
</audio>

<div id="loginScreen">
 <div class="login">
  <h3>ENTER IRC</h3>
  <input id="u" placeholder="username">
  <input id="r" placeholder="room">
  <button onclick="enter()">CONNECT</button>
 </div>
</div>

<div id="app">
 <div class="header">
   ‚õß CYBER IRC ‚õß 
   <div id="roomName" class="room"></div>
   <div id="onlineStatus" class="typing" style="display:none"></div>
 </div>
 <div id="chat" class="chat"></div>
 <div id="replying" class="reply-ref" style="display:none"></div>
 <div class="input-wrap">
  <span class="cursor">$</span>
  <input id="i" placeholder="type message">
 </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const chat = document.getElementById("chat");
const input = document.getElementById("i");
const replying = document.getElementById("replying");
const messageSound = document.getElementById("messageSound");
const onlineStatus = document.getElementById("onlineStatus");

let USER = localStorage.getItem("user");
let ROOM = localStorage.getItem("room");
let replyTo = null;
let typingTimer;
let encrypted = false;
let clearedTimestamp = 0;
let onlineUsers = new Set();
let userLastSeen = {};

if(USER && ROOM) start();

function enter(){
 USER=u.value.trim();
 ROOM=r.value.trim();
 localStorage.setItem("user",USER);
 localStorage.setItem("room",ROOM);
 start();
}

async function start(){
 loginScreen.style.display="none";
 app.style.display="flex";
 roomName.innerText="#"+ROOM;
 socket.emit("join",{user:USER,room:ROOM});
 
 // Get cleared timestamp from server
 try {
   const response = await fetch('/api/user-info', {
     method: 'POST',
     headers: {'Content-Type':'application/json'},
     body: JSON.stringify({username:USER})
   });
   if(response.ok){
     const data = await response.json();
     if(data.clearedRooms && data.clearedRooms[ROOM]){
       clearedTimestamp = data.clearedRooms[ROOM];
     }
   }
 } catch(err){
   console.log("Could not fetch user info");
 }
}

/* ---------- HISTORY ---------- */
socket.on("history", msgs => {
 chat.innerHTML="";
 // Filter out messages before cleared timestamp
 const filteredMsgs = clearedTimestamp > 0 
   ? msgs.filter(m => new Date(m.created).getTime() > clearedTimestamp)
   : msgs;
 filteredMsgs.forEach(render);

 if (document.visibilityState === "visible") {
   filteredMsgs.forEach(m=>{
    if(m.user!==USER){
     socket.emit("msg:read", m._id);
    }
   });
 }
 chat.scrollTop=chat.scrollHeight;
});

/* ---------- NEW MESSAGE ---------- */
socket.on("msg", m=>{
 // Play sound for new messages
 playMessageSound();
 
 // Render with typewriter effect
 renderWithTypewriter(m);
 
 if(m.user!==USER && document.visibilityState==="visible"){
  socket.emit("msg:read", m._id);
 }
});

/* ---------- PLAY MESSAGE SOUND ---------- */
function playMessageSound(){
 try {
   messageSound.currentTime = 0;
   messageSound.play().catch(e => console.log("Audio play failed:", e));
 } catch(err){
   console.log("Sound error:", err);
 }
}

/* ---------- TYPEWRITER EFFECT ---------- */
function renderWithTypewriter(m){
 const el=document.createElement("div");
 el.className="msg";
 el.dataset.id=m._id;

 el.innerHTML=`
 ${m.replyTo?`<div class="reply-ref">‚Ü™ ${m.replyTo.user}: ${m.replyTo.text.slice(0,40)}</div>`:""}
 <span class="time">[${new Date(m.created).toLocaleTimeString([],{
  hour:"2-digit",minute:"2-digit"})}]</span>
 <span class="${m.user===USER?'self':'other'}">${m.user}@${ROOM}</span>
 :: <span class="text"></span>
 ${m.user===USER?`<span class="tick delivered">‚úî</span>`:""}
 `;
 
 // Add last seen indicator for other users
 if(m.user !== USER && !onlineUsers.has(m.user)){
   const lastSeen = userLastSeen[m.user];
   if(lastSeen){
     const lastSeenEl = document.createElement("span");
     lastSeenEl.className = "last-seen";
     lastSeenEl.style.fontSize = "9px";
     lastSeenEl.style.color = "#055";
     lastSeenEl.style.marginLeft = "6px";
     lastSeenEl.innerText = `(last seen ${formatLastSeen(lastSeen)})`;
     el.querySelector(`.${m.user===USER?'self':'other'}`).after(lastSeenEl);
   }
 }
 
 chat.appendChild(el);
 chat.scrollTop=chat.scrollHeight;

 // Typewriter effect
 const textEl = el.querySelector(".text");
 const fullText = m.text;
 let i = 0;
 
 function typeWriter(){
   if(i < fullText.length){
     textEl.innerHTML += fullText.charAt(i);
     i++;
     setTimeout(typeWriter, 30); // Adjust speed here
   }
 }
 
 // Start typing effect
 setTimeout(() => typeWriter(), 100);

 el.onclick=()=>{
  replyTo={messageId:m._id,user:m.user,text:m.text,created:m.created};
  replying.innerText=`‚Ü™ replying to ${m.user}`;
  replying.style.display="block";
 };
}

/* ---------- FORMAT LAST SEEN ---------- */
function formatLastSeen(timestamp){
 const now = Date.now();
 const diff = now - timestamp;
 const minutes = Math.floor(diff / (1000 * 60));
 const hours = Math.floor(diff / (1000 * 60 * 60));
 const days = Math.floor(diff / (1000 * 60 * 60 * 24));
 
 if(minutes < 1) return "just now";
 if(minutes < 60) return `${minutes}m ago`;
 if(hours < 24) return `${hours}h ago`;
 return `${days}d ago`;
}

/* ---------- READ RECEIPT ---------- */
socket.on("msg:read", data => {
 const el=document.querySelector(`[data-id="${data.id}"]`);
 if(!el) return;
 const tick=el.querySelector(".tick");
 if(!tick) return;
 tick.classList.remove("delivered");
 tick.classList.add("read");
});

/* ---------- USER ONLINE/OFFLINE STATUS ---------- */
socket.on("user:online", ({ user, lastSeen }) => {
 onlineUsers.add(user);
 updateOnlineStatus();
 
 if(user !== USER){
   onlineStatus.style.display = "block";
   onlineStatus.innerHTML = `<span style="color:#00ff00">‚óè</span> ${user} is online`;
   setTimeout(() => {
     onlineStatus.style.display = "none";
   }, 3000);
 }
});

socket.on("user:offline", ({ user, lastSeen }) => {
 onlineUsers.delete(user);
 userLastSeen[user] = lastSeen;
 updateOnlineStatus();
 
 if(user !== USER){
   onlineStatus.style.display = "block";
   onlineStatus.innerHTML = `<span style="color:#ff3b3b">‚óè</span> ${user} is offline`;
   setTimeout(() => {
     onlineStatus.style.display = "none";
   }, 3000);
 }
});

function updateOnlineStatus(){
 const onlineCount = onlineUsers.size;
 const statusText = onlineCount > 1 ? 
   `${onlineCount-1} other user${onlineCount-1 > 1 ? 's' : ''} online` : 
   'You are alone';
 onlineStatus.innerHTML = `<span style="color:#0ff">‚óè</span> ${statusText}`;
}

/* ===============================
   üî• REAL-TIME WHATSAPP FIX üî•
   =============================== */
function markDeliveredAsRead(){
 document.querySelectorAll(".msg").forEach(el=>{
  const id=el.dataset.id;
  const tick=el.querySelector(".tick");
  if(id && tick && tick.classList.contains("delivered")){
   socket.emit("msg:read",id);
  }
 });
}
document.addEventListener("visibilitychange",()=>{
 if(document.visibilityState==="visible"){
  markDeliveredAsRead();
 }
});
window.addEventListener("focus", markDeliveredAsRead);
/* =============================== */

/* ---------- TYPING ---------- */
input.oninput=()=>{
 socket.emit("typing:start");
 clearTimeout(typingTimer);
 typingTimer=setTimeout(()=>socket.emit("typing:stop"),600);
};
socket.on("typing:start",u=>{
 replying.innerText=`${u} typing‚Ä¶`;
 replying.style.display="block";
});
socket.on("typing:stop",()=>{
 if(!replyTo) replying.style.display="none";
});

/* ---------- ENCRYPT ---------- */
function toggleEncrypt(on){
 document.querySelectorAll(".msg").forEach(el=>{
  const textEl=el.querySelector(".text");
  if(!textEl) return;
  if(on){
   if(!el.dataset.raw) el.dataset.raw=textEl.textContent;
   textEl.textContent=textEl.textContent
    .split("")
    .map(c=>String.fromCharCode(0x4e00+(c.charCodeAt(0)%2000)))
    .join("");
  }else if(el.dataset.raw){
   textEl.textContent=el.dataset.raw;
  }
 });
}

/* ---------- INPUT ---------- */
input.onkeydown=e=>{
 if(e.key!=="Enter") return;
 const text=input.value.trim();
 if(!text) return;

 if(text==="/clear"){
   // Clear only for this user
   socket.emit("clear:history");
   chat.innerHTML="<div style='color:#0aa;text-align:center;padding:20px;'>Chat cleared for you</div>";
   clearedTimestamp = Date.now();
   input.value="";
   return;
 }
 if(text==="/leave"){localStorage.clear();location.reload();return;}
 if(text==="/encrypt"){encrypted=true;toggleEncrypt(true);input.value="";return;}
 if(text==="/decrypt"){encrypted=false;toggleEncrypt(false);input.value="";return;}

 socket.emit("msg",{text,replyTo});
 replyTo=null;
 replying.style.display="none";
 input.value="";
};

/* ---------- CLEAR COMPLETE ---------- */
socket.on("clear:complete", () => {
 console.log("Chat history cleared for this user");
});

/* ---------- LAST SEEN REQUEST ---------- */
function requestLastSeen(user){
 socket.emit("lastseen:request", { user });
}

socket.on("lastseen:response", ({ user, timestamp, isOnline }) => {
 userLastSeen[user] = timestamp;
 // Update UI if needed
 const userElements = document.querySelectorAll(`[data-user="${user}"]`);
 userElements.forEach(el => {
   const indicator = el.querySelector('.last-seen');
   if(indicator && !isOnline){
     indicator.innerText = `(last seen ${formatLastSeen(timestamp)})`;
   }
 });
});

/* ---------- CANCEL REPLY ---------- */
document.addEventListener("click",e=>{
 if(!e.target.closest(".msg") && !e.target.closest(".input-wrap")){
  replyTo=null;
  replying.style.display="none";
 }
});

/* ---------- REGULAR RENDER (for history) ---------- */
function render(m){
 const el=document.createElement("div");
 el.className="msg";
 el.dataset.id=m._id;
 el.dataset.user=m.user;

 el.innerHTML=`
 ${m.replyTo?`<div class="reply-ref">‚Ü™ ${m.replyTo.user}: ${m.replyTo.text.slice(0,40)}</div>`:""}
 <span class="time">[${new Date(m.created).toLocaleTimeString([],{
  hour:"2-digit",minute:"2-digit"})}]</span>
 <span class="${m.user===USER?'self':'other'}">${m.user}@${ROOM}</span>
 :: <span class="text">${m.text}</span>
 ${m.user===USER?`<span class="tick delivered">‚úî</span>`:""}
 `;
 
 // Add last seen indicator for other users
 if(m.user !== USER && !onlineUsers.has(m.user)){
   const lastSeen = userLastSeen[m.user];
   if(lastSeen){
     const lastSeenEl = document.createElement("span");
     lastSeenEl.className = "last-seen";
     lastSeenEl.style.fontSize = "9px";
     lastSeenEl.style.color = "#055";
     lastSeenEl.style.marginLeft = "6px";
     lastSeenEl.innerText = `(last seen ${formatLastSeen(lastSeen)})`;
     el.querySelector(`.${m.user===USER?'self':'other'}`).after(lastSeenEl);
   }
 }
 
 chat.appendChild(el);
 chat.scrollTop=chat.scrollHeight;

 el.onclick=()=>{
  replyTo={messageId:m._id,user:m.user,text:m.text,created:m.created};
  replying.innerText=`‚Ü™ replying to ${m.user}`;
  replying.style.display="block";
 };
}
</script>
</body>
</html>
