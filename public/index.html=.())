<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<title>Cyber IRC</title>

<style>
*{box-sizing:border-box}
html,body{
 margin:0;height:100%;
 background:#04060b;
 font-family:'Share Tech Mono',monospace;
 color:#00ffcc;
 overflow:hidden;
}

/* Scanlines */
body::after{
 content:"";
 position:fixed;inset:0;
 pointer-events:none;
 background:repeating-linear-gradient(
  to bottom,
  rgba(0,0,0,0) 0px,
  rgba(0,0,0,0) 2px,
  rgba(0,0,0,.15) 3px
 );
 opacity:.25;
}

/* LOGIN */
#loginScreen{
 position:fixed;inset:0;
 display:flex;align-items:center;justify-content:center;
 background:#04060b;z-index:100;
}
.login{
 width:90%;max-width:320px;
 border:1px solid rgba(0,255,255,.3);
 padding:22px;
}
.login h3{
 font-family:'Orbitron',sans-serif;
 color:#0ff;text-align:center;
 letter-spacing:2px;
}
.login input,.login button{
 width:100%;margin:10px 0;padding:10px;
 background:#000;border:1px solid rgba(0,255,255,.35);
 color:#00ffcc;
}

/* APP */
#app{display:none;height:100dvh;flex-direction:column}
.header{
 font-family:'Orbitron',sans-serif;
 text-align:center;
 padding:10px;
 border-bottom:1px solid rgba(0,255,255,.3);
 text-shadow:0 0 6px rgba(0,255,255,.6);
}
.room{font-size:11px;color:#0aa}

/* CHAT */
.chat{flex:1;overflow-y:auto;padding:12px}
.msg{margin-bottom:8px;line-height:1.5}
.msg:hover{background:rgba(0,255,255,.04)}
.time{font-size:10px;color:#055;margin-right:6px}
.prompt{font-size:11px;margin-right:6px}
.self{color:#00ffff}
.other{color:#ff6b6b}

/* Reply preview */
.reply-ref{
 font-size:11px;
 color:#0aa;
 border-left:2px solid #0ff;
 padding-left:6px;
 margin-bottom:4px;
}

/* INPUT */
.input-wrap{
 display:flex;align-items:center;
 border-top:1px solid rgba(0,255,255,.3);
 background:#000;padding:10px;
}
.cursor{
 color:#0ff;margin-right:6px;
 animation:blink 1s steps(1) infinite;
}
input.msgbox{
 flex:1;background:#000;border:none;outline:none;
 color:#00ffcc;font-size:16px;
 font-family:'Share Tech Mono',monospace;
}

@keyframes blink{50%{opacity:0}}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
 <div class="login">
  <h3>ENTER IRC</h3>
  <input id="u" placeholder="username">
  <input id="r" placeholder="room">
  <button onclick="enter()">CONNECT</button>
 </div>
</div>

<!-- CHAT -->
<div id="app">
 <div class="header">
  ⛧ CYBER IRC ⛧
  <div id="roomName" class="room"></div>
 </div>

 <div id="chat" class="chat"></div>

 <div id="replying" class="reply-ref" style="display:none"></div>

 <div class="input-wrap">
  <span class="cursor">$</span>
  <input id="i" class="msgbox" placeholder="type message">
 </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

const loginScreen = document.getElementById("loginScreen");
const app = document.getElementById("app");
const chat = document.getElementById("chat");
const input = document.getElementById("i");
const replying = document.getElementById("replying");

let USER, ROOM;
let replyTo = null;
let pendingReply = null;
let autoScroll = true;

/* clear timestamp */
function clearedAt(){
 return Number(localStorage.getItem("clearedAt") || 0);
}

/* Restore */
const su = localStorage.getItem("user");
const sr = localStorage.getItem("room");
if(su && sr) start(su, sr);

function enter(){
 const u = document.getElementById("u").value.trim();
 const r = document.getElementById("r").value.trim();
 if(!u || !r) return;
 localStorage.setItem("user", u);
 localStorage.setItem("room", r);
 start(u, r);
}

function start(user, room){
 USER = user; ROOM = room;
 loginScreen.style.display = "none";
 app.style.display = "flex";
 document.getElementById("roomName").innerText = "#" + room;

 socket.emit("join", { user, room });
 input.focus();

 chat.onscroll = () => {
  autoScroll = chat.scrollTop + chat.clientHeight >= chat.scrollHeight - 10;
 };

 input.onkeydown = e => {
  if(e.key === "Enter" && input.value.trim()){
   const val = input.value.trim();

   if(val === "/clear"){
    chat.innerHTML = "";
    localStorage.setItem("clearedAt", Date.now());
    input.value = "";
    return;
   }

   if(val === "/leave"){
    localStorage.clear();
    location.reload();
    return;
   }

   pendingReply = replyTo;
   socket.emit("msg", val);   // STRING ONLY
   input.value = "";
   replyTo = null;
   replying.style.display = "none";
  }
 };

 socket.off("history");
 socket.off("msg");

 socket.on("history", msgs => {
  chat.innerHTML = "";
  const cut = clearedAt();

  msgs
   .filter(m => new Date(m.created).getTime() > cut)
   .sort((a,b)=>new Date(a.created)-new Date(b.created)) // ✅ ORDER FIX
   .forEach(render);

  chat.scrollTop = chat.scrollHeight;
 });

 socket.on("msg", m => {
  if(new Date(m.created).getTime() <= clearedAt()) return;
  render(m);
 });
}

function render(m){
 const t = new Date(m.created || Date.now())
  .toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
 const self = m.user === USER;

 chat.innerHTML += `
 <div class="msg">
  ${pendingReply ? `<div class="reply-ref">↪ ${pendingReply.user}@${pendingReply.time}</div>` : ""}
  <span class="time">[${t}]</span>
  <span class="prompt ${self?'self':'other'}">${self?'$':'#'} ${m.user}@${ROOM}</span>
  :: ${m.text}
 </div>`;

 pendingReply = null;
 if(autoScroll) chat.scrollTop = chat.scrollHeight;
}
</script>
</body>
</){
html>
.",
	
function render(m){
 const t = new Date(m.created || Date.now())
  .toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
 const self = m.user === USER;

 chat.innerHTML += `
 <div class="msg">
  ${pendingReply ? `<div class="reply-ref">↪ ${pendingReply.user}@${pendingReply.time}</div>` : ""}
  <span class="time">[${t}]</span>
  <span class="prompt ${self?'self':'other'}">${self?'$':'#'} ${m.user}@${ROOM}</span>
  :: ${m.text}
 </div>`;

 pendingReply = null;
 if(autoScroll) chat.scrollTop = chat.scrollHeight;
}
=

.function render(m){
 const t = new Date(m.created || Date.now())
  .toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
 const self = m.user === USER;

 chat.innerHTML += `
 <div class="msg">
  ${pendingReply ? `<div class="reply-ref">↪ ${pendingReply.user}@${pendingReply.time}</div>` : ""}
  <span class="time">[${t}]</span>
  <span class="prompt ${self?'self':'other'}">${self?'$':'#'} ${m.user}@${ROOM}</span>
  :: ${m.text}
 </div>`;

 pendingReply = null;
 if(autoScroll) chat.scrollTop = chat.scrollHeight;
}




=
"
.	
}<
>`
:
""}

<
>
="">{
?'<
="
